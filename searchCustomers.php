<?php //Session is verify, and header is presented. include('includes/_.php'); check_auth(); if ( $_SESSION['access_level'] < 3) {	die('<h1>Unauthorized</h1>');        } $_SESSION['view'] = 'Customers'; get_header(); //This file will display a customer search form.  If the form is submitted, it will //search the database for customers matching the search criteria, and then display //the results. //Function displayResults accepts an sql response object, and uses it to construct //appropriate html output to display its contents. function displayResults($db) {			//Head of table displayed.            echo" <h3>Found customers</h3>				<div id='profileBox'></div>				<form method='GET'>                <table  align='center' id='employeesTable' class='profile_sect'>                <tr align = 'center'>                <th> &nbsp &nbsp First Name &nbsp &nbsp </th>                <th> &nbsp &nbsp Last Name &nbsp &nbsp </th>                <th> &nbsp &nbsp e-Mail ID &nbsp &nbsp </th>                <th> &nbsp &nbsp Street Address &nbsp &nbsp </th>                <th> &nbsp &nbsp Suite &nbsp &nbsp </th>                <th> &nbsp &nbsp City &nbsp &nbsp </th>                <th> &nbsp &nbsp State &nbsp &nbsp </th>                <th> &nbsp &nbsp Zipcode &nbsp &nbsp </th>                <th> &nbsp &nbsp Type &nbsp &nbsp </th>                </tr>				";			//Contents of table diplayed.            $counter=0;            while($rows = $db->result->fetch_assoc())            {                $counter+=1;                echo"                        <tr align = 'center' id = '$counter' onmouseover = 'changeRowColor(this,true);' onmouseout = 'changeRowColor(this,false);'                onclick='pageRedirect($counter);'>                            <td>$rows[first_name]</td>                            <td>$rows[last_name]</td>                            <td>&nbsp $rows[email] &nbsp</td>                            <td>$rows[street]</td>							<td>$rows[suite]</td>                            <td>$rows[city]</td>                            <td>$rows[state]</td>                            <td>$rows[zipcode]</td>							";				if($rows['type']=="b") {echo"<td>Business</td>";}				else {echo"<td>Individual</td>";}                echo"</tr>";            }			echo" </table></form>"; }?><h1>Customers</h1><?php	//If the form was submitted, search for customers matching criteria	 if(isset($_GET['submit'])) {		 //Imports variables from the submitted form.		 $first_name = $_GET['firstname'];		 $last_name = $_GET['lastname'];		 $email = $_GET['email'];		 $city = $_GET['city'];		 $state = $_GET['state'];		 $zip = $_GET['zip'];		 $busName = $_GET['busName'];		 $busWebsite = $_GET['busWebsite'];		 $busContact = $_GET['busContact'];		 $ordSDate = $_GET['ordSDate'];		 $ordEDate = $_GET['ordEDate'];		 $ordType = $_GET['ordType'];		 $comSDate = $_GET['comSDate'];		 $comEDate = $_GET['comEDate'];		 $leadSDate = $_GET['leadSDate'];		 $leadEDate = $_GET['leadEDate'];		 $leadType = $_GET['leadType'];		 $leadRank = $_GET['leadRank'];		 //Forms myqsl query to search for customers matching all criteria		 $dataString = "";		 $added = false;		 $added2 = false;		 $goahead = false; 		 //Customer criteria		 if($first_name!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."first_name like ('%$first_name%')";}		 if($last_name!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."last_name like ('%$last_name%')";}		 if($email!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."email like ('%$email%')";}		 if($city!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."city = like ('%$city%')";}		 if($state!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."state = '".$state."'";}		 if($zip!="") {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."zipcode = '".$zip."'";}		 //Business specific criteria		 if(isset($_GET['typeB']))		 {			if($busName!="") {					if($added||$added2){$dataString=$dataString." and ";}					if(!$added2){					$dataString=$dataString."id in (select customer_id from business_customers where ";} $added=true;$added2=true;$dataString=$dataString."business_name like ('%$busName%')";}			if($busWebsite!="") {if($added||$added2){$dataString=$dataString." and ";}					if(!$added2){$dataString=$dataString."id in (select customer_id from business_customers where ";}$added=true;$added2=true;$dataString=$dataString."url like ('%$busWebsite%')";}			if($busContact!="") {if($added||$added2){$dataString=$dataString." and ";}					if(!$added2){$dataString=$dataString."id in (select customer_id from business_customers where ";}$added=true;$added2=true;$dataString=$dataString."contact_title ('%$busContact%')";}			 if($added2) {$dataString=$dataString.")";}		 }		 //Orders criteria		 $added2 = false;		 if($ordSDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_orders where ";} $added=true;$added2=true;				$dataString=$dataString."date > '".$ordSDate."'";}		 if($ordEDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_orders where ";} $added=true;$added2=true;				$dataString=$dataString."date < '".$ordEDate."'";}		 if($ordType!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_orders where ";} $added=true;$added2=true;				$dataString=$dataString."service_id = '".$ordType."'";}		 if($added2) {$dataString=$dataString.")";}		 //Complaints criteria		 $added2 = false;		 if($comSDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_complaints where ";} $added=true;$added2=true;				$dataString=$dataString."time > '".$comSDate."'";}		 if($comEDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_complaints where ";} $added=true;$added2=true;				$dataString=$dataString."time < '".$comEDate."'";}		 if(isset($_GET['comOpen'])&&!isset($_GET['comClosed'])) {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_complaints where ";} $added=true;$added2=true;				$dataString=$dataString."status = '1'";}		 if(isset($_GET['comClosed'])&&!isset($_GET['comOpen'])) {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_complaints where ";} $added=true;$added2=true;				$dataString=$dataString."status = '0'";}		 if(isset($_GET['comClosed'])&&isset($_GET['comOpen'])) {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_complaints where ";} $added=true;$added2=true;				$dataString=$dataString."(status = '0' or status = '1')";}		 if($added2) {$dataString=$dataString.")";}		 //Leads criteria		 $added2 = false;		 if($leadSDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_leads where ";} $added=true;$added2=true;				$dataString=$dataString."date > '".$leadSDate."'";}		 if($leadEDate!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_leads where ";} $added=true;$added2=true;				$dataString=$dataString."date < '".$leadEDate."'";}		 if($leadType!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_leads where ";} $added=true;$added2=true;				$dataString=$dataString."lead_id in (select id from leads where type = '".$leadType."')";}		 if($leadRank!="") {if($added||$added2){$dataString=$dataString." and ";}				if(!$added2){$dataString=$dataString."id in (select customer_id from customer_leads where ";} $added=true;$added2=true;				$dataString=$dataString."rank = '".$leadRank."'";}		 if($added2) {$dataString=$dataString.")";}		 //Customer type criteria		 if(isset($_GET['typeI'])&&!isset($_GET['typeB']))			 {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."type = 'i'";}		 if(!isset($_GET['typeI'])&&isset($_GET['typeB']))			 {if($added){$dataString=$dataString." and ";} $added=true;$dataString=$dataString."type = 'b'";}		 if(isset($_GET['typeI'])&&isset($_GET['typeB'])) {$goahead=true;}		 if($added) {$goahead=true;}		 //Executes sql query.		 if($goahead) { if($added){$dataString="where ".$dataString;}		 $db->runQuery("select first_name,last_name,email,street,suite,city,state,zipcode,type from customers $dataString");		 	  if  ($db->result->num_rows > 0)			  {				  displayResults($db);				  $customerFound=1;			  }			  else			 {				  echo "<h5>No customers found</h5>";			 }		 }	}//The following html code constructs the customer search form.?><h3>Find a customer</h3><div id="customer-search-wrap" style="padding-bottom:0px"><form id="find-customer" ><ul class="search-criteria-list multi"><li><a href="" class="toggler">Details</a><table id="#details" class="table2"><tr><td>First name<td><td><input type="text" class="full" name="firstname"/></td></tr><tr><td>Last name<td><td><input type="text" class="full" name="lastname"/></td></tr><tr><td>Email Address<td><td><input type="text" class="full" name="email"/></td></tr><tr><td>City<td><td><input type="text" class="mid" name="city"/></td></tr><tr><td>State<td><td><input type="text" class="mid" name="state"/></td></tr><tr><td>Zipcode<td><td><input type="text" maxlength="5" size="5" name="zip"/></td></tr><tr><td>Type<td><td><input type="checkbox" name="typeI" checked="true"/>Individual<input type="checkbox" name="typeB" checked="true"/>Business</td></tr></table></li><li><a href="#" class="toggler">Business Details</a><table class="table2 hidden" id="business_details"><tr><td>Company<td><td><input type="text" class="full" name="busName"/></td></tr><tr><td>Website<td><td><input type="text" class="full" name="busWebsite"/></td></tr><tr><td>Contact<td><td><input type="text" class="full" name="busContact"/></td></tr></table></li><!--<li><a href="#" class="toggler">Orders</a><table class="table2 hidden"><tr><td>Order Date<td align="right">from: <td><input id="orderStartDate" type="text" class="date-field" name="ordSDate"/></td></tr><tr><td><td align="right">to: <td><input id="orderEndDate" type="text" class="date-field" name="ordEDate"/></td></tr><tr><td>Order type<td><td><select name="ordType"><option value=""></option><?php	$db->runQuery("select distinct id,description from services");    while($rows = $db->result->fetch_assoc())    {		$str = '<option value="'.$rows[id].'">'.$rows[description].'</option>';        echo $str;    }?></select></td></tr></table></li>--><li><a href="#" class="toggler">Complaints</a><table class="table2 hidden"><tr><td>Complaint Date<td align="right">from: <td><input id="complaintStartDate" type="text" class="date-field" name="comSDate"/></td></tr><tr><td><td align="right">to: <td><input id="complaintEndDate" type="text" class="date-field" name="comEDate"/></td></tr><tr><td>Complaint Status<td><td><input type="checkbox" name="comOpen"/>Open<input type="checkbox" name="comClosed"/>Closed</td></tr></table></li><li><a href="#" class="toggler">Leads</a><table class="table2 hidden"><tr><td>Creation Date<td align="right">from: <td><input id="leadStartDate" type="text" class="date-field" name="leadSDate"/></td></tr><tr><td><td align="right">to: <td><input id="leadEndDate" type="text" class="date-field" name="leadEDate"/></td></tr><tr><td>Lead type<td><td><select name="leadType"><option value=""></option><?php	$db->runQuery("select distinct type from leads");    while($rows = $db->result->fetch_assoc())    {		$str = '<option value="'.$rows[type].'">'.$rows[type].'</option>';        echo $str;    }?></select></td></tr><tr><td>Rank<td><td><select name="leadRank"><option value=""></option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td></tr></table></ul><div style="background:#fff;border-top:15px solid #fff;"><input type="submit" value="Search" name="submit" /></div></form></div><script type='text/javascript'>var date_defaults = {	dateFormat: 'yy-mm-dd',	changeMonth: true,	changeYear: true,	yearRange: '2000:'};$('#complaintStartDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('#complaintEndDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('#orderStartDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('#orderEndDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('#leadStartDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('#leadEndDate').datepicker(date_defaults).attr('size','10').addClass('datefield');$('.toggler').click(function(){	$(this).siblings('.table2').toggle();	return false;});	</script><?php 	//Adds footer.	get_footer(); ?>