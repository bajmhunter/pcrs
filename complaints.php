<?phpinclude('includes/_.php');check_auth();$_SESSION['view'] = 'Complaints';//set customer id//a customer may only view his/her complaints so uid defaults to session id$cust_id = ($_SESSION['access_level']==1) ? $_SESSION['user_id'] : $_GET['cid'];//set ajax mode$ajaxmode = (isset($_GET['ajaxmode']) ) ? true : false;//response$response;switch($_GET['action']){		case 'add_complaint' :		addComplaint();		break;			default :		listComplaints();		break;	}/*-------------------------------------------------------------    @name:    getComplaint    @purpose: Returns a single complaint specified by its id  ------------------------------------------------------------*/function getComplaint(){	global $db;		$query = sprintf("select * from customer_complaints where id = %s;",1);	$db->runQuery($query);		//while( $row = $db->result->fetch_object() ){			//echo json_encode( $db->result->fetch_object() );		if(ajaxmode) exit();}function addComplaint(){	global $db, $cust_id;	$query = sprintf("insert into customer_complaints(customer_id,title,details) values %s,'%s','%s';",$cust_id,$title,$details);	$db->runQuery($query);		//successful insert	if($db->result){		if($ajaxmode){			$response['status'] = 1;			echo json_encode($response);		}		else{} //pr	}	//unsuccessful insert	else{		if($ajaxmode){			$response['status'] = 0;			echo json_encode($response);		}	}		if(ajaxmode) exit();}function listComplaints(){	global $db, $cust_id, $response;		$query = sprintf("SELECT concat(c.first_name, ' ', c.last_name) as fullname, c.id as cid, cc.id as id, cc.status as status, cc.time as time, cc.title as title, cc.details as details FROM `customer_complaints`as cc inner join `customers` as c;");	$db->runQuery($query);		$list = array();	while( $row = $db->result->fetch_object() ){		$curr->id = 'complaint-'.$row->id;		$curr->stat = ($row->status==1) ? 'open' : 'closed';		$curr->info = '<div class="header"><h4>'. $row->title .'</h4>';		$cust = ($_SESSION['access_level'] == 4) ? '| by <a href="profile.php?domain=customers&id='.$row->cid.'">'.$row->fullname.'</a>' : '';		$curr->info .= '<small>'. mysql_to_date( $row->time ) .$cust.'</small></div>';		$curr->info .= '<p>'.$row->details.'</p>';		$list[] = $curr;	}	if($ajaxmode){		echo json_encode( $list );		exit();	}	//$response['History'] = $list;	$response->History = $list;}if( $_SESSION['access_level'] == 1 ){	$response->Add = <<<ADDFORM<h3>File a new complaint</h3><form id="add-complaint-form" class="form1" action="#"><ul><li><label>Subject</label><input type="text" class="full" name="title"/></li><li><label>Details</label><textarea name="details"></textarea></li><li><input type="hidden" action="add_complaint" /><input type="submit" value="Submit" /></li></ul></form>ADDFORM;}get_header(); ?><div id="complaints"><h1 id="complaints-h1">Complaints</h1></div><script type="text/javascript">var data = <?php echo json_encode( $response ); ?>;var list = ['<ul class="complaint-list">'];var ogHTML = '';for(var i=0; i<data['History'].length;  i++){	var curr = data['History'][i];	list.push('<li class="',curr['stat'],'">',curr['info'],'</li>');}list.push('</ul>');ogHTML += list.join('');if( data['Add']!=null ){	$stage = $('#complaints');	$('#complaints-h1').addClass('wtabselect');	$stage.append('<ul class="tabselect"><li><a href="#complaints-list">Recent</a></li><li><a href="#add-complaint">Add Complaint</a></li></ul><div id="complaints-list" class="tab-content"></div><div id="add-complaint" class="tab-content"></div>');	$('#complaints-list').html(ogHTML);	$('#add-complaint').html(data['Add']);	$stage.tabs();	ogHTML = $stage.html();}else{	ogHTML = '<div id="compalaints-list">'+ogHTML+'</div>';	$('#complaints').append( ogHTML );}</script><?php get_footer(); ?><!--<h1 class="wtabselect">Complaints</h1><ul class="tabselect"><li><a href="#complaint-history">History</a></li><li><a href="#new-complaint">File New</a></li></ul><div id="complaint-history" class="clearall"><h3>History</h3>April 2010<ul class="complaint-list"><li><span class="status open">Open</span><div class="header"><h4>Latest Complaint</h4><small>Tuesday April 6th 2010</small></div><p>Since the Data to be entered is sent in from either the manager or one ofthe sales person, the Employee is presented with forms based on selectedtype of Data Entry Option. For Example, if the Data to be entered isregarding coupons/discounts a form is presented where the employeeenters all information about the coupon/discount – Name, Date of Expiry,Type, Eligibility Criteria and description. This information is then stored inthe DB where a coupon ID is auto generated and all information is thenvisible to manager, sales person or customers....</p><p><a href="#">Respond</a> | <a href="#">Close</a> | <a href="#">Delete </a></p></li><li><span class="status closed">Closed</span><div class="header"><h4>A Closed complaint</h4><small>Monday April 5th 2010</small></div><p>Since the Data to be entered is sent in from either the manager or one ofthe sales person, the Employee is presented with forms based on selectedtype of Data Entry Option. For Example, if the Data to be entered isregarding coupons/discounts a form is presented where the employeeenters all information about the coupon/discount – Name, Date of Expiry,...</p><p><a href="#">Respond</a> | <a href="#">Open</a> | <a href="#">Delete </a></p></li></ul></div><div id="new-complaint" class="clearall"></div></div>-->